# Proto3 Design Notes: Feasible Range Precomputation

## Goal
寸法拘束の「破綻しない範囲」を事前に推定し、単変数変更だけでなく**複数変数同時変更**でも破綻しない領域を扱えるようにする。

## 前提
- FreeCAD/Sketcher の拘束は相互依存で、**単一寸法の範囲と多変数の範囲は一致しない**。
- 厳密な解析（制約多様体の解析解）は現実的でない。
- 実用上は **サンプリング + 探索 + 失敗判定**が最も堅い。

## 解決策の全体像

1) **単変数の安全域 (1D) を推定**
   - 各寸法を1つずつ変更し、破綻しない範囲（min/max）を探索。
   - 得られるのは**「単独変更時」の安全域**。

2) **多変数の安全域 (nD) を推定**
   - 代表点サンプリング (Latin Hypercube / Sobol など) を行い、
     `recompute + surface check` が通るかを判定。
   - 成功点集合から **安全領域の近似境界**を作る。
   - 近似は以下のどれか:
     - 近傍許容率（基準点からの相対変化率の上限）
     - 楕円体（共分散） or 線形制約（凸包近似）
     - 単純な「同時変化の上限係数」表

3) **ランタイム適用**
   - 入力CSVを読む前に「推定範囲」でバリデーション。
   - 範囲外は「警告 or エラー」。
   - 許容範囲内でも最終的に `recompute + surface check` で確定。

## 具体的なアルゴリズム案

### A. 単変数探索 (1D)
- 各パラメータについて二分探索で許容範囲を推定。
- 手順:
  1. 基準値 v0
  2. 上方向: v0 -> v0*(1+r) を拡大しながら破綻点を探す
  3. 破綻点が見つかったら二分探索で閾値を詰める
  4. 下方向も同様
- 出力: `param -> [min, max]`

### B. 多変数探索 (nD)
- 基準値ベクトル v0 を中心に、正規化された比率空間で探索:
  - 変数 i の比率 `ri = vi / v0i`
- サンプル集合 S を生成し、各点で再計算:
  - `apply -> recompute -> surface check`
- 成功点の集合から安全領域を近似:
  - 例1: 各変数の許容変化率 `ri` の同時上限係数
  - 例2: 成功点の共分散 → 楕円体判定
  - 例3: 成功点の凸包（高次元は重いので縮約）

### C. 実運用の「簡易ルール」
現実的な運用としては以下の混合が扱いやすい:
- 単変数の `min/max` を使い **即時バリデーション**
- さらに「同時変化の係数 k」を導入  
  例: `|ri - 1|` の合計が `k` 未満なら許容

## 破綻判定の基準 (Proto3と一致)
- `doc.recompute()` 後の `obj.State` に `Invalid` / `RecomputeError`
- Surface (Face) の `Shape` が `isNull` / `!isValid` / `check()` 失敗
- `Area <= 0`

## 生成物（想定）

1) **range_1d.json**
```json
{
  "CROWN-D-L": { "min": 0.6, "max": 1.1 },
  "SHOULDER-ANGLE-OUT": { "min": 90, "max": 140 }
}
```

2) **range_nd.json**
```json
{
  "scale_limits": {
    "sum_abs_ratio_delta_max": 1.2
  },
  "covariance": [[...]]
}
```

3) **safety_rules.md**
- 人間が調整するための注意事項/例外ルール

## Proto3への統合案
- `proto3-codex/range_1d.json` を読み込み
  - 範囲外は即エラー
- `range_nd.json` がある場合は追加判定
  - 範囲外なら警告 or エラー
- 最終判定は必ず FreeCAD で実モデル検証

## 注意点
- 探索は時間がかかる → **別プログラム（オフラインバッチ）**で実行
- 破綻判定はモデル依存 → しきい値は経験的に調整
- 「安全域は更新頻度に応じて再計算」

## まとめ
厳密解は困難だが、**単変数探索 + 多変数サンプリング**で
実用的な安全範囲を生成できる。Proto3ではこの範囲を**事前バリデーション**
として使い、最終チェックはFreeCADで確定する構成が堅い。
