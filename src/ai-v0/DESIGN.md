# AI-v0 モデル設計書

## 1. 目的

### 1.1 プロジェクトの背景
- FreeCAD + CAEによる最適化パイプラインにおいて、CAD成立性を事前判定するガードモデル
- Optunaが提案するパラメータがCAD的に破綻しないかを高速に推論

### 1.2 モデルの役割
```
Optuna提案 → AI-v0で safe確率推論 → safe ≥ 閾値 のみ CAD生成・CAE実行
```

---

## 2. 問題設定

| 項目     | 値                               |
| -------- | -------------------------------- |
| タスク   | 2値分類 (safe: 0/1)              |
| 入力     | 20次元の寸法パラメータ（比率値） |
| 出力     | safe確率 P(safe                  | x) |
| 主指標   | F1, ROC-AUC                      |
| 補助指標 | Accuracy, Precision, Recall      |

### 重要な要件
- **Unsafe Recall重視**: CAEガードとして偽陰性（Unsafeを見逃す）を最小化したい
- **高速推論**: 最適化ループ内で使うため1ms以下の推論時間

---

## 3. データ

### 3.1 データソース
`proto3-hybrid` アルゴリズムでFreeCADを繰り返し評価して生成

### 3.2 現在のデータ量

| データセット   | サンプル数  | Safe比率  | 特徴                        |
| -------------- | ----------- | --------- | --------------------------- |
| 初期 (100K)    | 100,000     | 63.6%     | LHS + simple sampling       |
| 境界追加 (20K) | 20,000      | 16.2%     | Active Learning（境界集中） |
| **マージ**     | **120,000** | **55.7%** | 上記を結合                  |

### 3.3 特徴量（20次元）
```
CROWN-D-L, CROWN-D-H, CROWN-W, PUSHER-D-H, PUSHER-D-L, TIP-D,
STROKE-OUT, STROKE-CENTER, FOOT-W, FOOT-MID, SHOULDER-ANGLE-OUT,
SHOULDER-ANGLE-IN, TOP-T, TOP-DROP, FOOT-IN, DIAMETER, HEIGHT,
TIP-DROP, SHOUDER-T, FOOT-OUT
```

---

## 4. モデルアーキテクチャ

### 4.1 採用モデル: MLP (Multi-Layer Perceptron)

**選定理由:**
1. 寸法間の非線形相互作用を表現可能
2. 推論速度が高速（<1ms）
3. 特徴量追加やデータ増加時に拡張しやすい

### 4.2 ハイパーパラメータチューニング
Optunaで探索する項目:

| パラメータ       | 探索範囲         |
| ---------------- | ---------------- |
| 層数             | 1-3              |
| 各層ユニット数   | 32-256           |
| 活性化関数       | relu, tanh       |
| L2正則化 (alpha) | 1e-5 - 0.1       |
| 学習率           | 1e-4 - 1e-2      |
| バッチサイズ     | 32, 64, 128, 256 |

---

## 5. 実験履歴

### 5.1 初期ベースライン (100Kデータ)

| モデル              | F1        | ROC-AUC   | 備考             |
| ------------------- | --------- | --------- | ---------------- |
| Logistic Regression | 0.742     | 0.764     | 線形ベースライン |
| Random Forest       | 0.819     | 0.859     |                  |
| XGBoost             | 0.879     | 0.882     |                  |
| **MLP (64-32)**     | **0.906** | **0.894** | 最良             |

### 5.2 Optuna最適化 (100Kデータ, 30トライアル)

| 指標     | 値                            |
| -------- | ----------------------------- |
| F1       | 0.907                         |
| ROC-AUC  | 0.896                         |
| 最適構成 | (32, 37), tanh, alpha=0.00075 |

**結論**: 微小な改善のみ。データ飽和の兆候。

### 5.3 境界データ追加 (120Kデータ, 30トライアル)

| 指標    | Before | After | 変化  |
| ------- | ------ | ----- | ----- |
| F1      | 0.907  | 0.860 | -4.7% |
| ROC-AUC | 0.896  | 0.864 | -3.2% |

**考察**: 
- 境界データ追加で分類が困難化
- Unsafe比率が36%→44%に増加
- テストセットにも難しいサンプルが含まれる
- **より現実的な性能評価**とも解釈可能

### 5.4 100トライアル再試行 (実行中)

30トライアルでは探索不足の可能性があるため、100トライアルで再実行中。

---

## 6. 今後の方針

### 短期
1. 100トライアル結果の評価
2. Unsafe Recall重視の閾値調整
3. 実運用テスト

### 中期
1. アンサンブル学習（MLP + XGBoost）
2. 不確実性推定（MCドロップアウト）
3. 継続学習パイプライン

### 長期
1. CAE失敗ログからの自動再学習
2. 閾値の自動調整
3. 形状物理ルールを組み込んだ制約学習

---

## 7. ディレクトリ構成

```
src/ai-v0/
├── README.md              # プロジェクト概要
├── DESIGN.md              # 本ドキュメント
├── train.py               # 基本学習スクリプト
├── train_optuna.py        # Optuna学習
├── merge_samples.py       # データマージユーティリティ
├── predict.py             # 推論スクリプト
├── proto3-hybrid_samples.csv  # 初期データ (100K)
├── merged_samples.csv     # マージ済みデータ (120K)
├── artifacts_optuna/      # 30トライアル成果物
└── artifacts_optuna_100/  # 100トライアル成果物
```
